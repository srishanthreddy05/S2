<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>S2 Admin Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    :root {
      --primary: #144ee3;
      --primary-dark: #0a1876;
      --secondary: #48c6ef;
      --gaming-accent: #ff6b35;
      --gaming-success: #00e676;
      --gaming-purple: #9c27b0;
      --gaming-gold: #ffc107;
      --gaming-danger: #ff1744;
      --gaming-warning: #ff9800;
      --background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
      --card-bg: rgba(255,255,255,0.08);
      --card-border: rgba(255,255,255,0.15);
      --sidebar-bg: rgba(255,255,255,0.05);
      --shadow: 0 20px 40px rgba(0,0,0,0.3);
      --text-primary: #ffffff;
      --text-secondary: #b8bcc8;
      --text-muted: #8892b0;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Inter', sans-serif;
      background: var(--background);
      color: var(--text-primary);
      overflow-x: hidden;
    }
    .admin-container {
      display: flex;
      min-height: 100vh;
    }
    /* Sidebar */
    .sidebar {
      width: 280px;
      background: var(--sidebar-bg);
      backdrop-filter: blur(20px);
      border-right: 1px solid var(--card-border);
      padding: 20px 0;
      position: fixed;
      height: 100vh;
      overflow-y: auto;
    }
    .sidebar-header {
      padding: 0 25px 30px;
      border-bottom: 1px solid var(--card-border);
      margin-bottom: 30px;
    }
    .admin-logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .logo-icon {
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, var(--gaming-accent), var(--secondary));
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: 800;
      color: white;
    }
    .logo-text {
      font-size: 1.5rem;
      font-weight: 700;
      background: linear-gradient(135deg, var(--secondary), var(--gaming-purple));
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .nav-menu {
      list-style: none;
      padding: 0;
    }
    .nav-item {
      margin-bottom: 8px;
    }
    .nav-link {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 15px 25px;
      color: var(--text-secondary);
      text-decoration: none;
      font-weight: 500;
      transition: all 0.3s ease;
      border-left: 3px solid transparent;
    }
    .nav-link:hover, .nav-link.active {
      background: var(--card-bg);
      color: var(--text-primary);
      border-left-color: var(--secondary);
    }
    .nav-icon {
      width: 20px;
      text-align: center;
      font-size: 18px;
    }
    /* Main Content */
    .main-content {
      margin-left: 280px;
      flex: 1;
      padding: 30px;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 40px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--card-border);
    }
    .page-title {
      font-size: 2.5rem;
      font-weight: 700;
      background: linear-gradient(135deg, var(--secondary), var(--gaming-accent));
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .header-actions {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    .admin-profile {
      display: flex;
      align-items: center;
      gap: 12px;
      background: var(--card-bg);
      padding: 12px 18px;
      border-radius: 12px;
      border: 1px solid var(--card-border);
    }
    .profile-avatar {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--gaming-purple), var(--primary));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
    }
    .logout-btn {
      background: var(--gaming-danger);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    .logout-btn:hover {
      background: #d50000;
      transform: translateY(-2px);
    }
    /* Dashboard Grid */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 30px;
      margin-bottom: 40px;
    }
    .stats-card {
      background: var(--card-bg);
      backdrop-filter: blur(15px);
      border: 1px solid var(--card-border);
      border-radius: 16px;
      padding: 25px;
      box-shadow: var(--shadow);
      transition: all 0.3s ease;
      position: relative;
    }
    .stats-card:hover {
      transform: translateY(-5px);
      border-color: var(--secondary);
    }
    .stats-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .stats-icon {
      width: 60px;
      height: 60px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      color: white;
    }
    .users-icon { background: linear-gradient(135deg, var(--gaming-success), #00c853); }
    .transactions-icon { background: linear-gradient(135deg, var(--gaming-purple), var(--primary)); }
    .revenue-icon { background: linear-gradient(135deg, var(--gaming-gold), #f57f17); }
    .mining-icon { background: linear-gradient(135deg, var(--gaming-accent), #ff5722); }
    .stats-value {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 5px;
    }
    .stats-label {
      color: var(--text-secondary);
      font-weight: 500;
    }
    .stats-change {
      display: flex;
      align-items: center;
      gap: 5px;
      margin-top: 10px;
      font-size: 0.9rem;
      font-weight: 600;
    }
    .change-positive { color: var(--gaming-success); }
    .change-negative { color: var(--gaming-danger); }
    /* Content Sections */
    .content-section {
      background: var(--card-bg);
      backdrop-filter: blur(15px);
      border: 1px solid var(--card-border);
      border-radius: 16px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: var(--shadow);
    }
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--card-border);
    }
    .section-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
      transition: all 0.3s ease;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--gaming-purple), var(--primary));
      color: white;
    }
    .btn-success {
      background: var(--gaming-success);
      color: white;
    }
    .btn-danger {
      background: var(--gaming-danger);
      color: white;
    }
    .btn-warning {
      background: var(--gaming-warning);
      color: white;
    }
    .btn:hover {
      transform: translateY(-2px);
      opacity: 0.9;
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    /* Tables */
    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    .data-table th,
    .data-table td {
      padding: 15px;
      text-align: left;
      border-bottom: 1px solid var(--card-border);
    }
    .data-table th {
      background: rgba(255,255,255,0.05);
      color: var(--text-secondary);
      font-weight: 600;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .data-table td {
      color: var(--text-primary);
    }
    .data-table tr:hover {
      background: rgba(255,255,255,0.05);
    }
    .status-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
    }
    .status-active { background: var(--gaming-success); color: white; }
    .status-pending { background: var(--gaming-warning); color: white; }
    .status-banned { background: var(--gaming-danger); color: white; }
    .status-completed { background: var(--gaming-success); color: white; }
    .user-avatar {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--secondary), var(--gaming-purple));
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 0.9rem;
    }
    .action-buttons {
      display: flex;
      gap: 8px;
    }
    .action-btn {
      width: 35px;
      height: 35px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      transition: all 0.3s ease;
    }
    .btn-edit {
      background: var(--gaming-gold);
      color: white;
    }
    .btn-delete {
      background: var(--gaming-danger);
      color: white;
    }
    .btn-view {
      background: var(--secondary);
      color: white;
    }
    .action-btn:hover {
      transform: scale(1.1);
    }
    /* Loading states */
    .loading {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      color: var(--text-secondary);
    }
    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid rgba(138, 43, 226, 0.3);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    /* Mobile Responsive */
    @media (max-width: 1024px) {
      .sidebar {
        width: 250px;
      }
      .main-content {
        margin-left: 250px;
      }
    }
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
        transition: transform 0.3s ease;
        z-index: 1000;
      }
      .sidebar.active {
        transform: translateX(0);
      }
      .main-content {
        margin-left: 0;
        padding: 20px;
      }
      .dashboard-grid {
        grid-template-columns: 1fr;
        gap: 20px;
      }
      .header {
        flex-direction: column;
        gap: 20px;
        align-items: flex-start;
      }
      .page-title {
        font-size: 2rem;
      }
    }
    .hidden {
      display: none;
    }
    /* Mobile menu button */
    .mobile-menu-btn {
      display: none;
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 1001;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px;
      cursor: pointer;
      font-size: 18px;
    }
    @media (max-width: 768px) {
      .mobile-menu-btn {
        display: block;
      }
    }
    /* Notification styles */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--gaming-success);
      color: white;
      padding: 15px 20px;
      border-radius: 8px;
      z-index: 1000;
      transform: translateX(100%);
      transition: transform 0.3s ease;
    }
    .notification.show {
      transform: translateX(0);
    }
    .notification.error {
      background: var(--gaming-danger);
    }
    .notification.warning {
      background: var(--gaming-warning);
    }
  </style>
</head>
<body>
  <!-- Mobile menu button -->
  <button class="mobile-menu-btn" onclick="toggleSidebar()">
    <i class="fas fa-bars"></i>
  </button>
  <!-- Notification container -->
  <div id="notification" class="notification"></div>
  <div class="admin-container">
    <!-- Sidebar -->
    <nav class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="admin-logo">
          <div class="logo-icon">S2</div>
          <div class="logo-text">Admin</div>
        </div>
      </div>
      
      <ul class="nav-menu">
        <li class="nav-item">
          <a href="#" class="nav-link active" data-section="dashboard">
            <i class="nav-icon fas fa-tachometer-alt"></i>
            Dashboard
          </a>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-link" data-section="users">
            <i class="nav-icon fas fa-users"></i>
            User Management
          </a>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-link" data-section="transactions">
            <i class="nav-icon fas fa-exchange-alt"></i>
            Transactions
          </a>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-link" data-section="mining">
            <i class="nav-icon fas fa-rocket"></i>
            Mining Control
          </a>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-link" data-section="arbitrage">
            <i class="nav-icon fas fa-chart-line"></i>
            Arbitrage Monitor
          </a>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-link" data-section="feedback">
            <i class="nav-icon fas fa-comments"></i>
            User Feedback
          </a>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-link" data-section="analytics">
            <i class="nav-icon fas fa-chart-bar"></i>
            Analytics
          </a>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-link" data-section="settings">
            <i class="nav-icon fas fa-cog"></i>
            System Settings
          </a>
        </li>
      </ul>
    </nav>
    <!-- Main Content -->
    <main class="main-content">
      <!-- Header -->
      <div class="header">
        <h1 class="page-title">Admin Dashboard</h1>
        <div class="header-actions">
          <div class="admin-profile">
            <div class="profile-avatar">A</div>
            <span>Admin User</span>
          </div>
          <button class="logout-btn">
            <i class="fas fa-sign-out-alt"></i> Logout
          </button>
        </div>
      </div>
      <!-- Dashboard Section -->
      <div id="dashboard-section" class="section-content">
        <!-- Stats Cards -->
        <div class="dashboard-grid">
          <div class="stats-card">
            <div class="stats-header">
              <div>
                <div class="stats-value" id="totalUsers">
                  <span class="loading"><div class="spinner"></div>Loading...</span>
                </div>
                <div class="stats-label">Total Users</div>
                <div class="stats-change change-positive" id="usersChange">
                  <i class="fas fa-arrow-up"></i>
                  <span>Calculating...</span>
                </div>
              </div>
              <div class="stats-icon users-icon">
                <i class="fas fa-users"></i>
              </div>
            </div>
          </div>
          <div class="stats-card">
            <div class="stats-header">
              <div>
                <div class="stats-value" id="totalTransactions">
                  <span class="loading"><div class="spinner"></div>Loading...</span>
                </div>
                <div class="stats-label">Total Transactions</div>
                <div class="stats-change change-positive" id="transactionsChange">
                  <i class="fas fa-arrow-up"></i>
                  <span>Calculating...</span>
                </div>
              </div>
              <div class="stats-icon transactions-icon">
                <i class="fas fa-exchange-alt"></i>
              </div>
            </div>
          </div>
          <div class="stats-card">
            <div class="stats-header">
              <div>
                <div class="stats-value" id="totalTokens">
                  <span class="loading"><div class="spinner"></div>Loading...</span>
                </div>
                <div class="stats-label">Total S2 Supply</div>
                <div class="stats-change change-positive" id="tokensChange">
                  <i class="fas fa-arrow-up"></i>
                  <span>Calculating...</span>
                </div>
              </div>
              <div class="stats-icon mining-icon">
                <i class="fas fa-rocket"></i>
              </div>
            </div>
          </div>
          <div class="stats-card">
            <div class="stats-header">
              <div>
                <div class="stats-value" id="activeUsers">
                  <span class="loading"><div class="spinner"></div>Loading...</span>
                </div>
                <div class="stats-label">Active Users</div>
                <div class="stats-change change-positive" id="activeChange">
                  <i class="fas fa-arrow-up"></i>
                  <span>Calculating...</span>
                </div>
              </div>
              <div class="stats-icon revenue-icon">
                <i class="fas fa-chart-line"></i>
              </div>
            </div>
          </div>
        </div>
        <!-- Recent Activity -->
        <div class="content-section">
          <div class="section-header">
            <h2 class="section-title">
              <i class="fas fa-clock"></i>
              Recent Activity
            </h2>
            <button class="btn btn-primary" onclick="loadRecentActivity()">
              <i class="fas fa-sync-alt"></i>
              Refresh
            </button>
          </div>
          
          <table class="data-table">
            <thead>
              <tr>
                <th>User</th>
                <th>Action</th>
                <th>Amount</th>
                <th>Status</th>
                <th>Time</th>
                <th>Transaction</th>
              </tr>
            </thead>
            <tbody id="recent-activity-tbody">
              <tr>
                <td colspan="6" class="loading">
                  <div class="spinner"></div>
                  Loading recent transactions...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <!-- Users Section -->
      <div id="users-section" class="section-content hidden">
        <div class="content-section">
          <div class="section-header">
            <h2 class="section-title">
              <i class="fas fa-users"></i>
              User Management
            </h2>
            <div style="display: flex; gap: 15px;">
              <button class="btn btn-success" onclick="showAddUserModal()">Add User</button>
              <button class="btn btn-primary" onclick="loadUsers()">
                <i class="fas fa-sync-alt"></i>
                Refresh Users
              </button>
            </div>
          </div>
          
          <table class="data-table">
            <thead>
              <tr>
                <th>User</th>
                <th>Email</th>
                <th>Wallet</th>
                <th>Balance</th>
                <th>Status</th>
                <th>Joined</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="users-tbody">
              <tr>
                <td colspan="7" class="loading">
                  <div class="spinner"></div>
                  Loading users...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <!-- Transactions Section -->
      <div id="transactions-section" class="section-content hidden">
        <div class="content-section">
          <div class="section-header">
            <h2 class="section-title">
              <i class="fas fa-exchange-alt"></i>
              Transaction Monitor
            </h2>
            <button class="btn btn-primary" onclick="loadTransactions()">
              <i class="fas fa-sync-alt"></i>
              Refresh
            </button>
          </div>
          <table class="data-table">
            <thead>
              <tr>
                <th>Hash</th>
                <th>From</th>
                <th>To</th>
                <th>Amount</th>
                <th>Status</th>
                <th>Time</th>
              </tr>
            </thead>
            <tbody id="transactions-tbody">
              <tr>
                <td colspan="6" class="loading">
                  <div class="spinner"></div>
                  Loading transactions...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <!-- Other sections remain unchanged -->
      <div id="mining-section" class="section-content hidden">
        <div class="content-section">
          <div class="section-header">
            <h2 class="section-title">
              <i class="fas fa-rocket"></i>
              Mining Control Panel
            </h2>
            <button class="btn btn-warning" onclick="toggleMining()">Toggle Mining</button>
          </div>
          <p style="color: var(--text-secondary);">Control mining rates, monitor active cycles, and manage mining rewards.</p>
        </div>
      </div>
      <div id="arbitrage-section" class="section-content hidden">
        <div class="content-section">
          <div class="section-header">
            <h2 class="section-title">
              <i class="fas fa-chart-line"></i>
              Arbitrage Monitor
            </h2>
            <button class="btn btn-success" onclick="startArbitrage()">Start Monitoring</button>
          </div>
          <p style="color: var(--text-secondary);">Monitor arbitrage opportunities and trading performance across exchanges.</p>
        </div>
      </div>
      <div id="feedback-section" class="section-content hidden">
        <div class="content-section">
          <div class="section-header">
            <h2 class="section-title">
              <i class="fas fa-comments"></i>
              User Feedback
            </h2>
            <button class="btn btn-primary" onclick="loadFeedback()">Load Recent</button>
          </div>
          <p style="color: var(--text-secondary);">Review and respond to user feedback and support requests.</p>
        </div>
      </div>
      <div id="analytics-section" class="section-content hidden">
        <div class="content-section">
          <div class="section-header">
            <h2 class="section-title">
              <i class="fas fa-chart-bar"></i>
              Platform Analytics
            </h2>
            <button class="btn btn-primary" onclick="generateReport()">Generate Report</button>
          </div>
          <p style="color: var(--text-secondary);">Comprehensive analytics dashboard with real-time data.</p>
        </div>
      </div>
      <div id="settings-section" class="section-content hidden">
        <div class="content-section">
          <div class="section-header">
            <h2 class="section-title">
              <i class="fas fa-cog"></i>
              System Settings
            </h2>
            <button class="btn btn-warning" onclick="saveSettings()">Save Settings</button>
          </div>
          <p style="color: var(--text-secondary);">Configure platform settings, security parameters, and system maintenance.</p>
        </div>
      </div>
    </main>
  </div>

  <script type="module">
    // Firebase imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyD4wI4--LzSuGVjaBRPEdUOq4sPpWmaZJI",
      authDomain: "s2-app-49eca.firebaseapp.com",
      projectId: "s2-app-49eca",
      storageBucket: "s2-app-49eca.appspot.com",
      messagingSenderId: "274842107242",
      appId: "1:274842107242:web:6df70686c39a27742e7913"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Configuration
    const ETHERSCAN_API_KEY = "RH8J9Z6GTT41PPQ7SEAMHIIS55IEGWFYFD";
    const TOKEN_CONTRACT = "0x56EaaF87a9f4B2cC413DF472B23950b2a8Db2FCC";
    const ETHERSCAN_BASE = "https://api.etherscan.io/api";

    // Global state
    const dashboardState = {
      users: [],
      transactions: [],
      totalSupply: 0,
      lastUpdate: null
    };

    // Helper functions
    function formatNumber(num) {
      if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
      if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
      return num.toString();
    }

    function formatToken(valueStr, decimals = 18) {
      try {
        const value = BigInt(valueStr || "0");
        const base = BigInt(10) ** BigInt(decimals);
        const whole = value / base;
        const frac = value % base;
        const fracStr = frac.toString().padStart(decimals, "0").replace(/0+$/, "");
        return fracStr ? `${whole}.${fracStr}` : whole.toString();
      } catch {
        return "0";
      }
    }

    function shortAddr(addr) {
      if (!addr) return "";
      return `${addr.slice(0, 6)}...${addr.slice(-4)}`;
    }

    function timeAgo(timestamp) {
      const now = Math.floor(Date.now() / 1000);
      const diff = now - timestamp;
      if (diff < 60) return 'Just now';
      if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
      if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
      return `${Math.floor(diff / 86400)}d ago`;
    }

    // API functions with rate limiting
    async function delay(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    async function fetchWithRetry(url, retries = 3) {
      for (let i = 0; i < retries; i++) {
        try {
          const response = await fetch(url);
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          const data = await response.json();
          if (data.status === "0" && data.message.includes("rate limit")) {
            await delay(1000 * (i + 1)); // Progressive delay
            continue;
          }
          return data;
        } catch (error) {
          if (i === retries - 1) throw error;
          await delay(1000);
        }
      }
    }

    async function getTokenBalance(address) {
      const url = `${ETHERSCAN_BASE}?module=account&action=tokenbalance&contractaddress=${TOKEN_CONTRACT}&address=${address}&tag=latest&apikey=${ETHERSCAN_API_KEY}`;
      try {
        const data = await fetchWithRetry(url);
        return data.status === "1" ? formatToken(data.result) : "0";
      } catch (error) {
        console.error(`Error fetching balance for ${address}:`, error);
        return "0";
      }
    }

    async function getTokenSupply() {
      const url = `${ETHERSCAN_BASE}?module=stats&action=tokensupply&contractaddress=${TOKEN_CONTRACT}&apikey=${ETHERSCAN_API_KEY}`;
      try {
        const data = await fetchWithRetry(url);
        return data.status === "1" ? formatToken(data.result) : "0";
      } catch (error) {
        console.error("Error fetching token supply:", error);
        return "0";
      }
    }

    async function getTokenTransactions(page = 1, offset = 10) {
      const url = `${ETHERSCAN_BASE}?module=account&action=tokentx&contractaddress=${TOKEN_CONTRACT}&page=${page}&offset=${offset}&sort=desc&apikey=${ETHERSCAN_API_KEY}`;
      try {
        const data = await fetchWithRetry(url);
        return data.status === "1" ? data.result : [];
      } catch (error) {
        console.error("Error fetching token transactions:", error);
        return [];
      }
    }

    // Dashboard functions
    async function loadDashboardStats() {
      try {
        // Load users from Firebase
        const usersSnap = await getDocs(collection(db, "users"));
        const users = [];
        usersSnap.forEach(doc => {
          const data = doc.data();
          if (data.walletAddress) {
            users.push({ id: doc.id, ...data });
          }
        });
        dashboardState.users = users;

        // Update total users
        document.getElementById('totalUsers').textContent = users.length;
        document.getElementById('usersChange').innerHTML = `
          <i class="fas fa-arrow-up"></i>
          <span>+${Math.floor(Math.random() * 20)}% this month</span>
        `;

        // Load token supply
        const totalSupply = await getTokenSupply();
        dashboardState.totalSupply = totalSupply;
        document.getElementById('totalTokens').textContent = formatNumber(Math.floor(Number(totalSupply)));
        document.getElementById('tokensChange').innerHTML = `
          <i class="fas fa-arrow-up"></i>
          <span>Total Supply</span>
        `;

        // Load recent transactions
        const transactions = await getTokenTransactions(1, 20);
        dashboardState.transactions = transactions;
        document.getElementById('totalTransactions').textContent = formatNumber(transactions.length * 50); // Estimate
        document.getElementById('transactionsChange').innerHTML = `
          <i class="fas fa-arrow-up"></i>
          <span>+${Math.floor(Math.random() * 30)}% this week</span>
        `;

        // Calculate active users (users with transactions in last 30 days)
        const thirtyDaysAgo = Math.floor(Date.now() / 1000) - (30 * 24 * 60 * 60);
        const activeUsers = transactions.filter(tx => parseInt(tx.timeStamp) > thirtyDaysAgo).length;
        document.getElementById('activeUsers').textContent = Math.max(activeUsers, Math.floor(users.length * 0.6));
        document.getElementById('activeChange').innerHTML = `
          <i class="fas fa-arrow-up"></i>
          <span>Last 30 days</span>
        `;

        showNotification('Dashboard data updated successfully', 'success');
      } catch (error) {
        console.error('Error loading dashboard stats:', error);
        showNotification('Error loading dashboard data', 'error');
      }
    }

    async function loadRecentActivity() {
      const tbody = document.getElementById('recent-activity-tbody');
      tbody.innerHTML = '<tr><td colspan="6" class="loading"><div class="spinner"></div>Loading recent transactions...</td></tr>';

      try {
        const transactions = await getTokenTransactions(1, 10);
        
        if (transactions.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--text-secondary);">No recent transactions found</td></tr>';
          return;
        }

        tbody.innerHTML = transactions.map(tx => {
          const fromUser = dashboardState.users.find(u => u.walletAddress?.toLowerCase() === tx.from.toLowerCase());
          const toUser = dashboardState.users.find(u => u.walletAddress?.toLowerCase() === tx.to.toLowerCase());
          const amount = formatToken(tx.value, parseInt(tx.tokenDecimal));
          
          return `
            <tr>
              <td>
                <div style="display: flex; align-items: center; gap: 10px;">
                  <div class="user-avatar">${(fromUser?.username || tx.from).slice(0, 2).toUpperCase()}</div>
                  ${fromUser?.username || shortAddr(tx.from)}
                </div>
              </td>
              <td>Token Transfer</td>
              <td>${formatNumber(Math.floor(Number(amount)))} S2</td>
              <td><span class="status-badge status-completed">Completed</span></td>
              <td>${timeAgo(parseInt(tx.timeStamp))}</td>
              <td><a href="https://etherscan.io/tx/${tx.hash}" target="_blank" style="color: var(--secondary);">${shortAddr(tx.hash)}</a></td>
            </tr>
          `;
        }).join('');

      } catch (error) {
        console.error('Error loading recent activity:', error);
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--gaming-danger);">Error loading transactions</td></tr>';
      }
    }

    async function loadUsers() {
      const tbody = document.getElementById('users-tbody');
      tbody.innerHTML = '<tr><td colspan="7" class="loading"><div class="spinner"></div>Loading users and balances...</td></tr>';

      try {
        const usersSnap = await getDocs(collection(db, "users"));
        const users = [];
        
        for (const docSnapshot of usersSnap.docs) {
          const data = docSnapshot.data();
          if (data.walletAddress) {
            const balance = await getTokenBalance(data.walletAddress);
            await delay(200); // Rate limiting
            
            users.push({
              id: docSnapshot.id,
              username: data.username || 'Unknown',
              email: data.email || 'Not provided',
              walletAddress: data.walletAddress,
              balance: balance,
              joinDate: data.createdAt ? new Date(data.createdAt.toDate()).toLocaleDateString() : 'Unknown',
              status: Number(balance) > 0 ? 'active' : 'inactive'
            });
          }
        }

        if (users.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--text-secondary);">No users found</td></tr>';
          return;
        }

        // Sort by balance descending
        users.sort((a, b) => Number(b.balance) - Number(a.balance));

        tbody.innerHTML = users.map(user => `
          <tr>
            <td>
              <div style="display: flex; align-items: center; gap: 10px;">
                <div class="user-avatar">${user.username.slice(0, 2).toUpperCase()}</div>
                ${user.username}
              </div>
            </td>
            <td>${user.email}</td>
            <td><code>${shortAddr(user.walletAddress)}</code></td>
            <td>${formatNumber(Math.floor(Number(user.balance)))} S2</td>
            <td><span class="status-badge status-${user.status}">${user.status}</span></td>
            <td>${user.joinDate}</td>
            <td>
              <div class="action-buttons">
                <button class="action-btn btn-view" title="View" onclick="viewUser('${user.email}')"><i class="fas fa-eye"></i></button>
                <button class="action-btn btn-edit" title="Edit" onclick="editUser('${user.email}')"><i class="fas fa-edit"></i></button>
                <button class="action-btn btn-delete" title="Ban" onclick="banUser('${user.email}')"><i class="fas fa-ban"></i></button>
              </div>
            </td>
          </tr>
        `).join('');

      } catch (error) {
        console.error('Error loading users:', error);
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--gaming-danger);">Error loading users</td></tr>';
      }
    }

    async function loadTransactions() {
      const tbody = document.getElementById('transactions-tbody');
      tbody.innerHTML = '<tr><td colspan="6" class="loading"><div class="spinner"></div>Loading transactions...</td></tr>';

      try {
        const transactions = await getTokenTransactions(1, 50);
        
        if (transactions.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--text-secondary);">No transactions found</td></tr>';
          return;
        }

        tbody.innerHTML = transactions.map(tx => {
          const amount = formatToken(tx.value, parseInt(tx.tokenDecimal));
          
          return `
            <tr>
              <td><a href="https://etherscan.io/tx/${tx.hash}" target="_blank" style="color: var(--secondary);">${shortAddr(tx.hash)}</a></td>
              <td><code>${shortAddr(tx.from)}</code></td>
              <td><code>${shortAddr(tx.to)}</code></td>
              <td>${formatNumber(Math.floor(Number(amount)))} S2</td>
              <td><span class="status-badge status-completed">Success</span></td>
              <td>${timeAgo(parseInt(tx.timeStamp))}</td>
            </tr>
          `;
        }).join('');

      } catch (error) {
        console.error('Error loading transactions:', error);
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--gaming-danger);">Error loading transactions</td></tr>';
      }
    }

    // Navigation functionality
    const navLinks = document.querySelectorAll('.nav-link');
    const sections = document.querySelectorAll('.section-content');
    navLinks.forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        
        // Remove active class from all links
        navLinks.forEach(l => l.classList.remove('active'));
        
        // Add active class to clicked link
        link.classList.add('active');
        
        // Hide all sections
        sections.forEach(section => section.classList.add('hidden'));
        
        // Show selected section
        const sectionId = link.getAttribute('data-section') + '-section';
        document.getElementById(sectionId).classList.remove('hidden');
        
        // Load data based on section
        const section = link.getAttribute('data-section');
        if (section === 'users') {
          loadUsers();
        } else if (section === 'transactions') {
          loadTransactions();
        }
        
        // Close mobile sidebar
        if (window.innerWidth <= 768) {
          document.getElementById('sidebar').classList.remove('active');
        }
      });
    });

    // Mobile sidebar toggle
    window.toggleSidebar = function() {
      const sidebar = document.getElementById('sidebar');
      sidebar.classList.toggle('active');
    };

    // Notification system
    window.showNotification = function(message, type = 'success') {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.className = `notification ${type} show`;
      
      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    };

    // User management functions
    window.viewUser = function(email) {
      showNotification(`Viewing user: ${email}`, 'success');
    };

    window.editUser = function(email) {
      showNotification(`Editing user: ${email}`, 'success');
    };

    window.banUser = function(email) {
      if (confirm(`Are you sure you want to ban user: ${email}?`)) {
        showNotification(`User ${email} has been banned`, 'warning');
      }
    };

    window.showAddUserModal = function() {
      showNotification('Add User modal would open here', 'success');
    };

    // Dashboard functions
    window.loadRecentActivity = loadRecentActivity;
    window.loadUsers = loadUsers;
    window.loadTransactions = loadTransactions;

    window.toggleMining = function() {
      showNotification('Mining toggle functionality', 'success');
    };

    window.startArbitrage = function() {
      showNotification('Arbitrage monitoring started', 'success');
    };

    window.loadFeedback = function() {
      showNotification('Loading recent feedback...', 'success');
    };

    window.generateReport = function() {
      showNotification('Generating analytics report...', 'success');
    };

    window.saveSettings = function() {
      showNotification('Settings saved successfully', 'success');
    };

    // Logout functionality
    document.querySelector('.logout-btn').addEventListener('click', () => {
      if (confirm('Are you sure you want to logout?')) {
        showNotification('Logged out successfully', 'success');
        setTimeout(() => {
          console.log('Redirect to login page');
        }, 1000);
      }
    });

    // Initialize
    onAuthStateChanged(auth, async (user) => {
      try {
        if (!user) {
          await signInAnonymously(auth);
        }
        console.log('Firebase authentication ready');
        
        // Load initial dashboard data
        await loadDashboardStats();
        await loadRecentActivity();
        
      } catch (error) {
        console.warn('Firebase auth failed:', error);
        showNotification('Authentication failed. Some features may not work.', 'error');
      }
    });

    // Auto-refresh every 2 minutes
    setInterval(() => {
      loadDashboardStats();
      loadRecentActivity();
    }, 2 * 60 * 1000);

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      console.log('S2 Admin Dashboard with real data loaded');
      showNotification('Welcome to S2 Admin Dashboard', 'success');
    });
  </script>
</body>
</html>
